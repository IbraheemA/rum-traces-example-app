{"ast":null,"code":"import { Batch, combine, HttpRequest } from '@datadog/browser-core';\nimport { LifeCycleEventType } from '../domain/lifeCycle';\nimport { RumEventType } from '../rawRumEvent.types';\nexport function startRumBatch(configuration, lifeCycle) {\n  var batch = makeRumBatch(configuration, lifeCycle);\n  lifeCycle.subscribe(LifeCycleEventType.RUM_EVENT_COLLECTED, function (serverRumEvent) {\n    if (serverRumEvent.type === RumEventType.VIEW) {\n      batch.upsert(serverRumEvent, serverRumEvent.view.id);\n    } else {\n      batch.add(serverRumEvent);\n    }\n  });\n  return {\n    stop: function () {\n      batch.stop();\n    }\n  };\n}\nfunction makeRumBatch(configuration, lifeCycle) {\n  var primaryBatch = createRumBatch(configuration.rumEndpoint, function () {\n    return lifeCycle.notify(LifeCycleEventType.BEFORE_UNLOAD);\n  });\n  var replicaBatch;\n  var replica = configuration.replica;\n  if (replica !== undefined) {\n    replicaBatch = createRumBatch(replica.rumEndpoint);\n  }\n  function createRumBatch(endpointUrl, unloadCallback) {\n    return new Batch(new HttpRequest(endpointUrl, configuration.batchBytesLimit, true), configuration.maxBatchSize, configuration.batchBytesLimit, configuration.maxMessageSize, configuration.flushTimeout, unloadCallback);\n  }\n  function withReplicaApplicationId(message) {\n    return combine(message, {\n      application: {\n        id: replica.applicationId\n      }\n    });\n  }\n  var stopped = false;\n  return {\n    add: function (message) {\n      if (stopped) {\n        return;\n      }\n      primaryBatch.add(message);\n      if (replicaBatch) {\n        replicaBatch.add(withReplicaApplicationId(message));\n      }\n    },\n    stop: function () {\n      stopped = true;\n    },\n    upsert: function (message, key) {\n      if (stopped) {\n        return;\n      }\n      primaryBatch.upsert(message, key);\n      if (replicaBatch) {\n        replicaBatch.upsert(withReplicaApplicationId(message), key);\n      }\n    }\n  };\n}","map":{"version":3,"names":["Batch","combine","HttpRequest","LifeCycleEventType","RumEventType","startRumBatch","configuration","lifeCycle","batch","makeRumBatch","subscribe","RUM_EVENT_COLLECTED","serverRumEvent","type","VIEW","upsert","view","id","add","stop","primaryBatch","createRumBatch","rumEndpoint","notify","BEFORE_UNLOAD","replicaBatch","replica","undefined","endpointUrl","unloadCallback","batchBytesLimit","maxBatchSize","maxMessageSize","flushTimeout","withReplicaApplicationId","message","application","applicationId","stopped","key"],"sources":["../../src/transport/batch.ts"],"sourcesContent":[null],"mappings":"AAAA,SAASA,KAAK,EAAEC,OAAO,EAA0BC,WAAW,QAAQ,uBAAuB;AAC3F,SAAoBC,kBAAkB,QAAQ,qBAAqB;AACnE,SAASC,YAAY,QAAQ,sBAAsB;AAGnD,OAAM,SAAUC,aAAaA,CAACC,aAA4B,EAAEC,SAAoB;EAC9E,IAAMC,KAAK,GAAGC,YAAY,CAACH,aAAa,EAAEC,SAAS,CAAC;EAEpDA,SAAS,CAACG,SAAS,CAACP,kBAAkB,CAACQ,mBAAmB,EAAE,UAACC,cAAkC;IAC7F,IAAIA,cAAc,CAACC,IAAI,KAAKT,YAAY,CAACU,IAAI,EAAE;MAC7CN,KAAK,CAACO,MAAM,CAACH,cAAc,EAAEA,cAAc,CAACI,IAAI,CAACC,EAAE,CAAC;KACrD,MAAM;MACLT,KAAK,CAACU,GAAG,CAACN,cAAc,CAAC;;EAE7B,CAAC,CAAC;EAEF,OAAO;IACLO,IAAI,WAAAA,CAAA;MACFX,KAAK,CAACW,IAAI,EAAE;IACd;GACD;AACH;AAQA,SAASV,YAAYA,CAACH,aAA4B,EAAEC,SAAoB;EACtE,IAAMa,YAAY,GAAGC,cAAc,CAACf,aAAa,CAACgB,WAAW,EAAE;IAC7D,OAAAf,SAAS,CAACgB,MAAM,CAACpB,kBAAkB,CAACqB,aAAa,CAAC;EAAlD,CAAkD,CACnD;EAED,IAAIC,YAA+B;EACnC,IAAMC,OAAO,GAAGpB,aAAa,CAACoB,OAAO;EACrC,IAAIA,OAAO,KAAKC,SAAS,EAAE;IACzBF,YAAY,GAAGJ,cAAc,CAACK,OAAO,CAACJ,WAAW,CAAC;;EAGpD,SAASD,cAAcA,CAACO,WAAmB,EAAEC,cAA2B;IACtE,OAAO,IAAI7B,KAAK,CACd,IAAIE,WAAW,CAAC0B,WAAW,EAAEtB,aAAa,CAACwB,eAAe,EAAE,IAAI,CAAC,EACjExB,aAAa,CAACyB,YAAY,EAC1BzB,aAAa,CAACwB,eAAe,EAC7BxB,aAAa,CAAC0B,cAAc,EAC5B1B,aAAa,CAAC2B,YAAY,EAC1BJ,cAAc,CACf;EACH;EAEA,SAASK,wBAAwBA,CAACC,OAAgB;IAChD,OAAOlC,OAAO,CAACkC,OAAO,EAAE;MAAEC,WAAW,EAAE;QAAEnB,EAAE,EAAES,OAAQ,CAACW;MAAa;IAAE,CAAE,CAAC;EAC1E;EAEA,IAAIC,OAAO,GAAG,KAAK;EACnB,OAAO;IACLpB,GAAG,EAAE,SAAAA,CAACiB,OAAgB;MACpB,IAAIG,OAAO,EAAE;QACX;;MAEFlB,YAAY,CAACF,GAAG,CAACiB,OAAO,CAAC;MACzB,IAAIV,YAAY,EAAE;QAChBA,YAAY,CAACP,GAAG,CAACgB,wBAAwB,CAACC,OAAO,CAAC,CAAC;;IAEvD,CAAC;IACDhB,IAAI,EAAE,SAAAA,CAAA;MACJmB,OAAO,GAAG,IAAI;IAChB,CAAC;IACDvB,MAAM,EAAE,SAAAA,CAACoB,OAAgB,EAAEI,GAAW;MACpC,IAAID,OAAO,EAAE;QACX;;MAEFlB,YAAY,CAACL,MAAM,CAACoB,OAAO,EAAEI,GAAG,CAAC;MACjC,IAAId,YAAY,EAAE;QAChBA,YAAY,CAACV,MAAM,CAACmB,wBAAwB,CAACC,OAAO,CAAC,EAAEI,GAAG,CAAC;;IAE/D;GACD;AACH","ignoreList":[]},"metadata":{},"sourceType":"module"}