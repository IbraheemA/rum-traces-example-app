{"ast":null,"code":"import { __awaiter, __generator } from \"tslib\";\nimport { monitor, callMonitored } from '../domain/internalMonitoring';\nimport { computeStackTrace } from '../domain/tracekit';\nimport { toStackTraceString } from '../tools/error';\nimport { elapsed, clocksNow, timeStampNow } from '../tools/timeUtils';\nimport { normalizeUrl } from '../tools/urlPolyfill';\nvar fetchProxySingleton;\nvar originalFetch;\nvar beforeSendCallbacks = [];\nvar onRequestCompleteCallbacks = [];\nexport function startFetchProxy() {\n  if (!fetchProxySingleton) {\n    proxyFetch();\n    fetchProxySingleton = {\n      beforeSend: function (callback) {\n        beforeSendCallbacks.push(callback);\n      },\n      onRequestComplete: function (callback) {\n        onRequestCompleteCallbacks.push(callback);\n      }\n    };\n  }\n  return fetchProxySingleton;\n}\nexport function resetFetchProxy() {\n  if (fetchProxySingleton) {\n    fetchProxySingleton = undefined;\n    beforeSendCallbacks.splice(0, beforeSendCallbacks.length);\n    onRequestCompleteCallbacks.splice(0, onRequestCompleteCallbacks.length);\n    window.fetch = originalFetch;\n  }\n}\nfunction proxyFetch() {\n  if (!window.fetch) {\n    return;\n  }\n  originalFetch = window.fetch;\n  window.fetch = function (input, init) {\n    var responsePromise;\n    var context = callMonitored(beforeSend, null, [input, init]);\n    if (context) {\n      responsePromise = originalFetch.call(this, context.input, context.init);\n      callMonitored(afterSend, null, [responsePromise, context]);\n    } else {\n      responsePromise = originalFetch.call(this, input, init);\n    }\n    return responsePromise;\n  };\n}\nfunction beforeSend(input, init) {\n  var method = init && init.method || typeof input === 'object' && input.method || 'GET';\n  var url = normalizeUrl(typeof input === 'object' && input.url || input);\n  var startClocks = clocksNow();\n  var context = {\n    init: init,\n    input: input,\n    method: method,\n    startClocks: startClocks,\n    url: url\n  };\n  beforeSendCallbacks.forEach(function (callback) {\n    return callback(context);\n  });\n  return context;\n}\nfunction afterSend(responsePromise, context) {\n  var _this = this;\n  var reportFetch = function (response) {\n    return __awaiter(_this, void 0, void 0, function () {\n      var text, e_1;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            context.duration = elapsed(context.startClocks.timeStamp, timeStampNow());\n            if (!('stack' in response || response instanceof Error)) return [3 /*break*/, 1];\n            context.status = 0;\n            context.responseText = toStackTraceString(computeStackTrace(response));\n            context.isAborted = response instanceof DOMException && response.code === DOMException.ABORT_ERR;\n            context.error = response;\n            onRequestCompleteCallbacks.forEach(function (callback) {\n              return callback(context);\n            });\n            return [3 /*break*/, 6];\n          case 1:\n            if (!('status' in response)) return [3 /*break*/, 6];\n            text = void 0;\n            _a.label = 2;\n          case 2:\n            _a.trys.push([2, 4,, 5]);\n            return [4 /*yield*/, response.clone().text()];\n          case 3:\n            text = _a.sent();\n            return [3 /*break*/, 5];\n          case 4:\n            e_1 = _a.sent();\n            text = \"Unable to retrieve response: \" + e_1;\n            return [3 /*break*/, 5];\n          case 5:\n            context.response = response;\n            context.responseText = text;\n            context.responseType = response.type;\n            context.status = response.status;\n            context.isAborted = false;\n            onRequestCompleteCallbacks.forEach(function (callback) {\n              return callback(context);\n            });\n            _a.label = 6;\n          case 6:\n            return [2 /*return*/];\n        }\n      });\n    });\n  };\n  responsePromise.then(monitor(reportFetch), monitor(reportFetch));\n}","map":{"version":3,"names":["monitor","callMonitored","computeStackTrace","toStackTraceString","elapsed","clocksNow","timeStampNow","normalizeUrl","fetchProxySingleton","originalFetch","beforeSendCallbacks","onRequestCompleteCallbacks","startFetchProxy","proxyFetch","beforeSend","callback","push","onRequestComplete","resetFetchProxy","undefined","splice","length","window","fetch","input","init","responsePromise","context","call","afterSend","method","url","startClocks","forEach","_this","reportFetch","response","__awaiter","duration","timeStamp","Error","status","responseText","isAborted","DOMException","code","ABORT_ERR","error","text","clone","_a","sent","e_1","responseType","type","then"],"sources":["../../src/browser/fetchProxy.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module"}