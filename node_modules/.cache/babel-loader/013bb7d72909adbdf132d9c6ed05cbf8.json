{"ast":null,"code":"import { monitor, Observable, timeStampNow } from '@datadog/browser-core';\nimport { LifeCycleEventType } from './lifeCycle';\n// Delay to wait for a page activity to validate the tracking process\nexport var PAGE_ACTIVITY_VALIDATION_DELAY = 100;\n// Delay to wait after a page activity to end the tracking process\nexport var PAGE_ACTIVITY_END_DELAY = 100;\n// Maximum duration of the tracking process\nexport var PAGE_ACTIVITY_MAX_DURATION = 10000;\nexport function waitIdlePageActivity(lifeCycle, domMutationObservable, completionCallback) {\n  var _a = trackPageActivities(lifeCycle, domMutationObservable),\n    pageActivitiesObservable = _a.observable,\n    stopPageActivitiesTracking = _a.stop;\n  var stopWaitPageActivitiesCompletion = waitPageActivitiesCompletion(pageActivitiesObservable, stopPageActivitiesTracking, completionCallback).stop;\n  var stop = function () {\n    stopWaitPageActivitiesCompletion();\n    stopPageActivitiesTracking();\n  };\n  return {\n    stop: stop\n  };\n}\n// Automatic action collection lifecycle overview:\n//                      (Start new trackPageActivities)\n//              .-------------------'--------------------.\n//              v                                        v\n//     [Wait for a page activity ]          [Wait for a maximum duration]\n//     [timeout: VALIDATION_DELAY]          [  timeout: MAX_DURATION    ]\n//          /                  \\                           |\n//         v                    v                          |\n//  [No page activity]   [Page activity]                   |\n//         |                   |,----------------------.   |\n//         v                   v                       |   |\n//     (Discard)     [Wait for a page activity]        |   |\n//                   [   timeout: END_DELAY   ]        |   |\n//                       /                \\            |   |\n//                      v                  v           |   |\n//             [No page activity]    [Page activity]   |   |\n//                      |                 |            |   |\n//                      |                 '------------'   |\n//                      '-----------. ,--------------------'\n//                                   v\n//                                 (End)\n//\n// Note: because MAX_DURATION > VALIDATION_DELAY, we are sure that if the process is still alive\n// after MAX_DURATION, it has been validated.\nexport function trackPageActivities(lifeCycle, domMutationObservable) {\n  var observable = new Observable();\n  var subscriptions = [];\n  var firstRequestIndex;\n  var pendingRequestsCount = 0;\n  subscriptions.push(domMutationObservable.subscribe(function () {\n    return notifyPageActivity();\n  }));\n  subscriptions.push(lifeCycle.subscribe(LifeCycleEventType.PERFORMANCE_ENTRY_COLLECTED, function (entry) {\n    if (entry.entryType !== 'resource') {\n      return;\n    }\n    notifyPageActivity();\n  }));\n  subscriptions.push(lifeCycle.subscribe(LifeCycleEventType.REQUEST_STARTED, function (startEvent) {\n    if (firstRequestIndex === undefined) {\n      firstRequestIndex = startEvent.requestIndex;\n    }\n    pendingRequestsCount += 1;\n    notifyPageActivity();\n  }));\n  subscriptions.push(lifeCycle.subscribe(LifeCycleEventType.REQUEST_COMPLETED, function (request) {\n    // If the request started before the tracking start, ignore it\n    if (firstRequestIndex === undefined || request.requestIndex < firstRequestIndex) {\n      return;\n    }\n    pendingRequestsCount -= 1;\n    notifyPageActivity();\n  }));\n  function notifyPageActivity() {\n    observable.notify({\n      isBusy: pendingRequestsCount > 0\n    });\n  }\n  return {\n    observable: observable,\n    stop: function () {\n      subscriptions.forEach(function (s) {\n        return s.unsubscribe();\n      });\n    }\n  };\n}\nexport function waitPageActivitiesCompletion(pageActivitiesObservable, stopPageActivitiesTracking, completionCallback) {\n  var idleTimeoutId;\n  var hasCompleted = false;\n  var validationTimeoutId = setTimeout(monitor(function () {\n    return complete({\n      hadActivity: false\n    });\n  }), PAGE_ACTIVITY_VALIDATION_DELAY);\n  var maxDurationTimeoutId = setTimeout(monitor(function () {\n    return complete({\n      hadActivity: true,\n      endTime: timeStampNow()\n    });\n  }), PAGE_ACTIVITY_MAX_DURATION);\n  pageActivitiesObservable.subscribe(function (_a) {\n    var isBusy = _a.isBusy;\n    clearTimeout(validationTimeoutId);\n    clearTimeout(idleTimeoutId);\n    var lastChangeTime = timeStampNow();\n    if (!isBusy) {\n      idleTimeoutId = setTimeout(monitor(function () {\n        return complete({\n          hadActivity: true,\n          endTime: lastChangeTime\n        });\n      }), PAGE_ACTIVITY_END_DELAY);\n    }\n  });\n  var stop = function () {\n    hasCompleted = true;\n    clearTimeout(validationTimeoutId);\n    clearTimeout(idleTimeoutId);\n    clearTimeout(maxDurationTimeoutId);\n    stopPageActivitiesTracking();\n  };\n  function complete(params) {\n    if (hasCompleted) {\n      return;\n    }\n    stop();\n    completionCallback(params);\n  }\n  return {\n    stop: stop\n  };\n}","map":{"version":3,"names":["monitor","Observable","timeStampNow","LifeCycleEventType","PAGE_ACTIVITY_VALIDATION_DELAY","PAGE_ACTIVITY_END_DELAY","PAGE_ACTIVITY_MAX_DURATION","waitIdlePageActivity","lifeCycle","domMutationObservable","completionCallback","_a","trackPageActivities","pageActivitiesObservable","observable","stopPageActivitiesTracking","stop","stopWaitPageActivitiesCompletion","waitPageActivitiesCompletion","subscriptions","firstRequestIndex","pendingRequestsCount","push","subscribe","notifyPageActivity","PERFORMANCE_ENTRY_COLLECTED","entry","entryType","REQUEST_STARTED","startEvent","undefined","requestIndex","REQUEST_COMPLETED","request","notify","isBusy","forEach","s","unsubscribe","idleTimeoutId","hasCompleted","validationTimeoutId","setTimeout","complete","hadActivity","maxDurationTimeoutId","endTime","clearTimeout","lastChangeTime","params"],"sources":["../../src/domain/trackPageActivities.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module"}