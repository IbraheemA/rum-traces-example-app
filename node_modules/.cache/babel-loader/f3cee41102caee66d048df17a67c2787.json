{"ast":null,"code":"import { noop, addEventListener, elapsed, relativeNow, addMonitoringMessage, toServerDuration } from '@datadog/browser-core';\n// Arbitrary value to cap number of element (mostly for backend)\nexport var MAX_NUMBER_OF_FOCUSED_TIME = 500;\nvar foregroundPeriods = [];\nexport function startForegroundContexts(configuration) {\n  if (!configuration.isEnabled('track-foreground')) {\n    return {\n      getInForeground: function () {\n        return undefined;\n      },\n      getInForegroundPeriods: function () {\n        return undefined;\n      },\n      stop: noop\n    };\n  }\n  if (document.hasFocus()) {\n    addNewForegroundPeriod();\n  }\n  var stopForegroundTracking = trackFocus(addNewForegroundPeriod).stop;\n  var stopBlurTracking = trackBlur(closeForegroundPeriod).stop;\n  return {\n    getInForeground: getInForeground,\n    getInForegroundPeriods: getInForegroundPeriods,\n    stop: function () {\n      foregroundPeriods = [];\n      stopForegroundTracking();\n      stopBlurTracking();\n    }\n  };\n}\nfunction addNewForegroundPeriod() {\n  if (foregroundPeriods.length > MAX_NUMBER_OF_FOCUSED_TIME) {\n    addMonitoringMessage('Reached maximum of foreground time');\n    return;\n  }\n  var currentForegroundPeriod = foregroundPeriods[foregroundPeriods.length - 1];\n  if (currentForegroundPeriod !== undefined && currentForegroundPeriod.end === undefined) {\n    addMonitoringMessage('Previous foreground periods not closed. Continuing current one');\n    return;\n  }\n  foregroundPeriods.push({\n    start: relativeNow()\n  });\n}\nfunction closeForegroundPeriod() {\n  if (foregroundPeriods.length === 0) {\n    addMonitoringMessage('No foreground period');\n    return;\n  }\n  var currentForegroundPeriod = foregroundPeriods[foregroundPeriods.length - 1];\n  if (currentForegroundPeriod.end !== undefined) {\n    addMonitoringMessage('Current foreground period already closed');\n    return;\n  }\n  currentForegroundPeriod.end = relativeNow();\n}\nfunction trackFocus(onFocusChange) {\n  return addEventListener(window, \"focus\" /* FOCUS */, function () {\n    return onFocusChange();\n  });\n}\nfunction trackBlur(onBlurChange) {\n  return addEventListener(window, \"blur\" /* BLUR */, function () {\n    return onBlurChange();\n  });\n}\nfunction getInForeground(startTime) {\n  for (var i = foregroundPeriods.length - 1; i >= 0; i--) {\n    var foregroundPeriod = foregroundPeriods[i];\n    if (foregroundPeriod.end !== undefined && startTime > foregroundPeriod.end) {\n      break;\n    }\n    if (startTime > foregroundPeriod.start && (foregroundPeriod.end === undefined || startTime < foregroundPeriod.end)) {\n      return true;\n    }\n  }\n  return false;\n}\nfunction getInForegroundPeriods(eventStartTime, duration) {\n  // eslint-disable-next-line @typescript-eslint/restrict-plus-operands\n  var eventEndTime = eventStartTime + duration;\n  var filteredForegroundPeriods = [];\n  for (var i = foregroundPeriods.length - 1; i >= 0; i--) {\n    var foregroundPeriod = foregroundPeriods[i];\n    if (foregroundPeriod.end !== undefined && eventStartTime > foregroundPeriod.end) {\n      // event starts after the end of the current focus period\n      // since the array is sorted, we can stop looking for foreground periods\n      break;\n    }\n    if (eventEndTime < foregroundPeriod.start) {\n      // event ends before the start of the current focus period\n      // continue to previous one\n      continue;\n    }\n    var startTime = eventStartTime > foregroundPeriod.start ? eventStartTime : foregroundPeriod.start;\n    var startDuration = elapsed(eventStartTime, startTime);\n    var endTime = foregroundPeriod.end === undefined || eventEndTime < foregroundPeriod.end ? eventEndTime : foregroundPeriod.end;\n    var endDuration = elapsed(startTime, endTime);\n    filteredForegroundPeriods.unshift({\n      start: toServerDuration(startDuration),\n      duration: toServerDuration(endDuration)\n    });\n  }\n  return filteredForegroundPeriods;\n}","map":{"version":3,"names":["noop","addEventListener","elapsed","relativeNow","addMonitoringMessage","toServerDuration","MAX_NUMBER_OF_FOCUSED_TIME","foregroundPeriods","startForegroundContexts","configuration","isEnabled","getInForeground","undefined","getInForegroundPeriods","stop","document","hasFocus","addNewForegroundPeriod","stopForegroundTracking","trackFocus","stopBlurTracking","trackBlur","closeForegroundPeriod","length","currentForegroundPeriod","end","push","start","onFocusChange","window","onBlurChange","startTime","i","foregroundPeriod","eventStartTime","duration","eventEndTime","filteredForegroundPeriods","startDuration","endTime","endDuration","unshift"],"sources":["../../src/domain/foregroundContexts.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module"}