{"ast":null,"code":"import { __assign } from \"tslib\";\nimport { getOrigin, objectEntries } from '@datadog/browser-core';\nexport function clearTracingIfCancelled(context) {\n  if (context.status === 0) {\n    context.traceId = undefined;\n    context.spanId = undefined;\n  }\n}\nexport function startTracer(configuration) {\n  return {\n    clearTracingIfCancelled: clearTracingIfCancelled,\n    traceFetch: function (context) {\n      return injectHeadersIfTracingAllowed(configuration, context, function (tracingHeaders) {\n        var _a;\n        if (context.input instanceof Request && !((_a = context.init) === null || _a === void 0 ? void 0 : _a.headers)) {\n          context.input = new Request(context.input);\n          Object.keys(tracingHeaders).forEach(function (key) {\n            ;\n            context.input.headers.append(key, tracingHeaders[key]);\n          });\n        } else {\n          context.init = __assign({}, context.init);\n          var headers_1 = [];\n          if (context.init.headers instanceof Headers) {\n            context.init.headers.forEach(function (value, key) {\n              headers_1.push([key, value]);\n            });\n          } else if (Array.isArray(context.init.headers)) {\n            context.init.headers.forEach(function (header) {\n              headers_1.push(header);\n            });\n          } else if (context.init.headers) {\n            Object.keys(context.init.headers).forEach(function (key) {\n              headers_1.push([key, context.init.headers[key]]);\n            });\n          }\n          context.init.headers = headers_1.concat(objectEntries(tracingHeaders));\n        }\n      });\n    },\n    traceXhr: function (context, xhr) {\n      return injectHeadersIfTracingAllowed(configuration, context, function (tracingHeaders) {\n        Object.keys(tracingHeaders).forEach(function (name) {\n          xhr.setRequestHeader(name, tracingHeaders[name]);\n        });\n      });\n    }\n  };\n}\nfunction injectHeadersIfTracingAllowed(configuration, context, inject) {\n  if (!isTracingSupported() || !isAllowedUrl(configuration, context.url)) {\n    return;\n  }\n  context.traceId = new TraceIdentifier();\n  context.spanId = new TraceIdentifier();\n  inject(makeTracingHeaders(context.traceId, context.spanId));\n}\nfunction isAllowedUrl(configuration, requestUrl) {\n  var requestOrigin = getOrigin(requestUrl);\n  for (var _i = 0, _a = configuration.allowedTracingOrigins; _i < _a.length; _i++) {\n    var allowedOrigin = _a[_i];\n    if (requestOrigin === allowedOrigin || allowedOrigin instanceof RegExp && allowedOrigin.test(requestOrigin)) {\n      return true;\n    }\n  }\n  return false;\n}\nexport function isTracingSupported() {\n  return getCrypto() !== undefined;\n}\nfunction getCrypto() {\n  return window.crypto || window.msCrypto;\n}\nfunction makeTracingHeaders(traceId, spanId) {\n  return {\n    'x-datadog-origin': 'rum',\n    'x-datadog-parent-id': spanId.toDecimalString(),\n    'x-datadog-sampled': '1',\n    'x-datadog-sampling-priority': '1',\n    'x-datadog-trace-id': traceId.toDecimalString()\n  };\n}\n/* eslint-disable no-bitwise */\nvar TraceIdentifier = /** @class */function () {\n  function TraceIdentifier() {\n    this.buffer = new Uint8Array(8);\n    getCrypto().getRandomValues(this.buffer);\n    this.buffer[0] = this.buffer[0] & 0x7f; // force 63-bit\n  }\n  TraceIdentifier.prototype.toString = function (radix) {\n    var high = this.readInt32(0);\n    var low = this.readInt32(4);\n    var str = '';\n    while (1) {\n      var mod = high % radix * 4294967296 + low;\n      high = Math.floor(high / radix);\n      low = Math.floor(mod / radix);\n      str = (mod % radix).toString(radix) + str;\n      if (!high && !low) {\n        break;\n      }\n    }\n    return str;\n  };\n  /**\n   * Format used everywhere except the trace intake\n   */\n  TraceIdentifier.prototype.toDecimalString = function () {\n    return this.toString(10);\n  };\n  TraceIdentifier.prototype.readInt32 = function (offset) {\n    return this.buffer[offset] * 16777216 + (this.buffer[offset + 1] << 16) + (this.buffer[offset + 2] << 8) + this.buffer[offset + 3];\n  };\n  return TraceIdentifier;\n}();\nexport { TraceIdentifier };\n/* eslint-enable no-bitwise */","map":{"version":3,"names":["getOrigin","objectEntries","clearTracingIfCancelled","context","status","traceId","undefined","spanId","startTracer","configuration","traceFetch","injectHeadersIfTracingAllowed","tracingHeaders","input","Request","_a","init","headers","Object","keys","forEach","key","append","__assign","headers_1","Headers","value","push","Array","isArray","header","concat","traceXhr","xhr","name","setRequestHeader","inject","isTracingSupported","isAllowedUrl","url","TraceIdentifier","makeTracingHeaders","requestUrl","requestOrigin","_i","allowedTracingOrigins","length","allowedOrigin","RegExp","test","getCrypto","window","crypto","msCrypto","toDecimalString","buffer","Uint8Array","getRandomValues","prototype","toString","radix","high","readInt32","low","str","mod","Math","floor","offset"],"sources":["../../../src/domain/tracing/tracer.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module"}