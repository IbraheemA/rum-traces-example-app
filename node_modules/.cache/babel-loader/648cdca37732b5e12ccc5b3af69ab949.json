{"ast":null,"code":"import { __assign } from \"tslib\";\nimport { addMonitoringMessage, elapsed, getPathName, includes, isValidUrl, ResourceType, toServerDuration, ONE_DAY, relativeNow, timeStampNow } from '@datadog/browser-core';\nexport var FAKE_INITIAL_DOCUMENT = 'initial_document';\nvar RESOURCE_TYPES = [[ResourceType.DOCUMENT, function (initiatorType) {\n  return FAKE_INITIAL_DOCUMENT === initiatorType;\n}], [ResourceType.XHR, function (initiatorType) {\n  return 'xmlhttprequest' === initiatorType;\n}], [ResourceType.FETCH, function (initiatorType) {\n  return 'fetch' === initiatorType;\n}], [ResourceType.BEACON, function (initiatorType) {\n  return 'beacon' === initiatorType;\n}], [ResourceType.CSS, function (_, path) {\n  return /\\.css$/i.test(path);\n}], [ResourceType.JS, function (_, path) {\n  return /\\.js$/i.test(path);\n}], [ResourceType.IMAGE, function (initiatorType, path) {\n  return includes(['image', 'img', 'icon'], initiatorType) || /\\.(gif|jpg|jpeg|tiff|png|svg|ico)$/i.exec(path) !== null;\n}], [ResourceType.FONT, function (_, path) {\n  return /\\.(woff|eot|woff2|ttf)$/i.exec(path) !== null;\n}], [ResourceType.MEDIA, function (initiatorType, path) {\n  return includes(['audio', 'video'], initiatorType) || /\\.(mp3|mp4)$/i.exec(path) !== null;\n}]];\nexport function computeResourceKind(timing) {\n  var url = timing.name;\n  if (!isValidUrl(url)) {\n    addMonitoringMessage(\"Failed to construct URL for \\\"\" + timing.name + \"\\\"\");\n    return ResourceType.OTHER;\n  }\n  var path = getPathName(url);\n  for (var _i = 0, RESOURCE_TYPES_1 = RESOURCE_TYPES; _i < RESOURCE_TYPES_1.length; _i++) {\n    var _a = RESOURCE_TYPES_1[_i],\n      type = _a[0],\n      isType = _a[1];\n    if (isType(timing.initiatorType, path)) {\n      return type;\n    }\n  }\n  return ResourceType.OTHER;\n}\nfunction areInOrder() {\n  var numbers = [];\n  for (var _i = 0; _i < arguments.length; _i++) {\n    numbers[_i] = arguments[_i];\n  }\n  for (var i = 1; i < numbers.length; i += 1) {\n    if (numbers[i - 1] > numbers[i]) {\n      return false;\n    }\n  }\n  return true;\n}\nexport function isRequestKind(timing) {\n  return timing.initiatorType === 'xmlhttprequest' || timing.initiatorType === 'fetch';\n}\nexport function computePerformanceResourceDuration(entry) {\n  var duration = entry.duration,\n    startTime = entry.startTime,\n    responseEnd = entry.responseEnd;\n  // Safari duration is always 0 on timings blocked by cross origin policies.\n  if (duration === 0 && startTime < responseEnd) {\n    return toServerDuration(elapsed(startTime, responseEnd));\n  }\n  if (duration > ONE_DAY) {\n    addMonitoringMessage('resource duration > 1 day', {\n      debug: {\n        type: entry.initiatorType,\n        name: entry.name,\n        startTime: Math.round(startTime),\n        responseEnd: Math.round(responseEnd),\n        duration: Math.round(duration),\n        relativeNow: Math.round(relativeNow()),\n        timeStampNow: timeStampNow()\n      }\n    });\n  }\n  return toServerDuration(duration);\n}\nexport function computePerformanceResourceDetails(entry) {\n  var validEntry = toValidEntry(entry);\n  if (!validEntry) {\n    return undefined;\n  }\n  var startTime = validEntry.startTime,\n    fetchStart = validEntry.fetchStart,\n    redirectStart = validEntry.redirectStart,\n    redirectEnd = validEntry.redirectEnd,\n    domainLookupStart = validEntry.domainLookupStart,\n    domainLookupEnd = validEntry.domainLookupEnd,\n    connectStart = validEntry.connectStart,\n    secureConnectionStart = validEntry.secureConnectionStart,\n    connectEnd = validEntry.connectEnd,\n    requestStart = validEntry.requestStart,\n    responseStart = validEntry.responseStart,\n    responseEnd = validEntry.responseEnd;\n  var details = {\n    download: formatTiming(startTime, responseStart, responseEnd),\n    first_byte: formatTiming(startTime, requestStart, responseStart)\n  };\n  // Make sure a connection occurred\n  if (connectEnd !== fetchStart) {\n    details.connect = formatTiming(startTime, connectStart, connectEnd);\n    // Make sure a secure connection occurred\n    if (areInOrder(connectStart, secureConnectionStart, connectEnd)) {\n      details.ssl = formatTiming(startTime, secureConnectionStart, connectEnd);\n    }\n  }\n  // Make sure a domain lookup occurred\n  if (domainLookupEnd !== fetchStart) {\n    details.dns = formatTiming(startTime, domainLookupStart, domainLookupEnd);\n  }\n  if (hasRedirection(entry)) {\n    details.redirect = formatTiming(startTime, redirectStart, redirectEnd);\n  }\n  return details;\n}\nexport function toValidEntry(entry) {\n  // Ensure timings are in the right order. On top of filtering out potential invalid\n  // RumPerformanceResourceTiming, it will ignore entries from requests where timings cannot be\n  // collected, for example cross origin requests without a \"Timing-Allow-Origin\" header allowing\n  // it.\n  if (!areInOrder(entry.startTime, entry.fetchStart, entry.domainLookupStart, entry.domainLookupEnd, entry.connectStart, entry.connectEnd, entry.requestStart, entry.responseStart, entry.responseEnd)) {\n    return undefined;\n  }\n  if (!hasRedirection(entry)) {\n    return entry;\n  }\n  var redirectStart = entry.redirectStart,\n    redirectEnd = entry.redirectEnd;\n  // Firefox doesn't provide redirect timings on cross origin requests.\n  // Provide a default for those.\n  if (redirectStart < entry.startTime) {\n    redirectStart = entry.startTime;\n  }\n  if (redirectEnd < entry.startTime) {\n    redirectEnd = entry.fetchStart;\n  }\n  // Make sure redirect timings are in order\n  if (!areInOrder(entry.startTime, redirectStart, redirectEnd, entry.fetchStart)) {\n    return undefined;\n  }\n  return __assign(__assign({}, entry), {\n    redirectEnd: redirectEnd,\n    redirectStart: redirectStart\n  });\n}\nfunction hasRedirection(entry) {\n  // The only time fetchStart is different than startTime is if a redirection occurred.\n  return entry.fetchStart !== entry.startTime;\n}\nfunction formatTiming(origin, start, end) {\n  return {\n    duration: toServerDuration(elapsed(start, end)),\n    start: toServerDuration(elapsed(origin, start))\n  };\n}\nexport function computeSize(entry) {\n  // Make sure a request actually occurred\n  if (entry.startTime < entry.responseStart) {\n    return entry.decodedBodySize;\n  }\n  return undefined;\n}\nexport function isAllowedRequestUrl(configuration, url) {\n  return url && !configuration.isIntakeUrl(url);\n}","map":{"version":3,"names":["addMonitoringMessage","elapsed","getPathName","includes","isValidUrl","ResourceType","toServerDuration","ONE_DAY","relativeNow","timeStampNow","FAKE_INITIAL_DOCUMENT","RESOURCE_TYPES","DOCUMENT","initiatorType","XHR","FETCH","BEACON","CSS","_","path","test","JS","IMAGE","exec","FONT","MEDIA","computeResourceKind","timing","url","name","OTHER","_i","RESOURCE_TYPES_1","length","_a","type","isType","areInOrder","numbers","arguments","i","isRequestKind","computePerformanceResourceDuration","entry","duration","startTime","responseEnd","debug","Math","round","computePerformanceResourceDetails","validEntry","toValidEntry","undefined","fetchStart","redirectStart","redirectEnd","domainLookupStart","domainLookupEnd","connectStart","secureConnectionStart","connectEnd","requestStart","responseStart","details","download","formatTiming","first_byte","connect","ssl","dns","hasRedirection","redirect","__assign","origin","start","end","computeSize","decodedBodySize","isAllowedRequestUrl","configuration","isIntakeUrl"],"sources":["../../../../src/domain/rumEventsCollection/resource/resourceUtils.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module"}