{"ast":null,"code":"import { areCookiesAuthorized, Batch, combine, commonInit, createErrorFilter, HttpRequest, limitModification, Observable, startAutomaticErrorCollection } from '@datadog/browser-core';\nimport { StatusType } from '../domain/logger';\nimport { startLoggerSession } from '../domain/loggerSession';\nimport { buildEnv } from './buildEnv';\nvar FIELDS_WITH_SENSITIVE_DATA = ['view.url', 'view.referrer', 'message', 'error.stack', 'http.url'];\nexport function startLogs(userConfiguration, errorLogger, getGlobalContext) {\n  var _a = commonInit(userConfiguration, buildEnv),\n    configuration = _a.configuration,\n    internalMonitoring = _a.internalMonitoring;\n  var errorObservable = userConfiguration.forwardErrorsToLogs !== false ? startAutomaticErrorCollection(configuration) : new Observable();\n  var session = startLoggerSession(configuration, areCookiesAuthorized(configuration.cookieOptions));\n  return doStartLogs(configuration, errorObservable, internalMonitoring, session, errorLogger, getGlobalContext);\n}\nexport function doStartLogs(configuration, errorObservable, internalMonitoring, session, errorLogger, getGlobalContext) {\n  internalMonitoring.setExternalContextProvider(function () {\n    return combine({\n      session_id: session.getId()\n    }, getGlobalContext(), getRUMInternalContext());\n  });\n  var assemble = buildAssemble(session, configuration, reportError);\n  var batch = startLoggerBatch(configuration);\n  function reportError(error) {\n    errorLogger.error(error.message, combine({\n      date: error.startClocks.timeStamp,\n      error: {\n        kind: error.type,\n        origin: error.source,\n        stack: error.stack\n      }\n    }, error.resource ? {\n      http: {\n        method: error.resource.method,\n        status_code: error.resource.statusCode,\n        url: error.resource.url\n      }\n    } : undefined, getRUMInternalContext(error.startClocks.relative)));\n  }\n  errorObservable.subscribe(reportError);\n  return function (message, currentContext) {\n    var contextualizedMessage = assemble(message, currentContext);\n    if (contextualizedMessage) {\n      batch.add(contextualizedMessage);\n    }\n  };\n}\nfunction startLoggerBatch(configuration) {\n  var primaryBatch = createLoggerBatch(configuration.logsEndpoint);\n  var replicaBatch;\n  if (configuration.replica !== undefined) {\n    replicaBatch = createLoggerBatch(configuration.replica.logsEndpoint);\n  }\n  function createLoggerBatch(endpointUrl) {\n    return new Batch(new HttpRequest(endpointUrl, configuration.batchBytesLimit), configuration.maxBatchSize, configuration.batchBytesLimit, configuration.maxMessageSize, configuration.flushTimeout);\n  }\n  return {\n    add: function (message) {\n      primaryBatch.add(message);\n      if (replicaBatch) {\n        replicaBatch.add(message);\n      }\n    }\n  };\n}\nexport function buildAssemble(session, configuration, reportError) {\n  var errorFilter = createErrorFilter(configuration, reportError);\n  return function (message, currentContext) {\n    if (!session.isTracked()) {\n      return undefined;\n    }\n    var contextualizedMessage = combine({\n      service: configuration.service,\n      session_id: session.getId()\n    }, currentContext, getRUMInternalContext(), message);\n    if (configuration.beforeSend) {\n      var shouldSend = limitModification(contextualizedMessage, FIELDS_WITH_SENSITIVE_DATA, configuration.beforeSend);\n      if (shouldSend === false) {\n        return undefined;\n      }\n    }\n    if (contextualizedMessage.status === StatusType.error && errorFilter.isLimitReached()) {\n      return undefined;\n    }\n    return contextualizedMessage;\n  };\n}\nfunction getRUMInternalContext(startTime) {\n  var rum = window.DD_RUM;\n  return rum && rum.getInternalContext ? rum.getInternalContext(startTime) : undefined;\n}","map":{"version":3,"names":["areCookiesAuthorized","Batch","combine","commonInit","createErrorFilter","HttpRequest","limitModification","Observable","startAutomaticErrorCollection","StatusType","startLoggerSession","buildEnv","FIELDS_WITH_SENSITIVE_DATA","startLogs","userConfiguration","errorLogger","getGlobalContext","_a","configuration","internalMonitoring","errorObservable","forwardErrorsToLogs","session","cookieOptions","doStartLogs","setExternalContextProvider","session_id","getId","getRUMInternalContext","assemble","buildAssemble","reportError","batch","startLoggerBatch","error","message","date","startClocks","timeStamp","kind","type","origin","source","stack","resource","http","method","status_code","statusCode","url","undefined","relative","subscribe","currentContext","contextualizedMessage","add","primaryBatch","createLoggerBatch","logsEndpoint","replicaBatch","replica","endpointUrl","batchBytesLimit","maxBatchSize","maxMessageSize","flushTimeout","errorFilter","isTracked","service","beforeSend","shouldSend","status","isLimitReached","startTime","rum","window","DD_RUM","getInternalContext"],"sources":["../../src/boot/startLogs.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module"}