{"ast":null,"code":"import { __assign } from \"tslib\";\nimport { combine, generateUUID, RequestType, ResourceType, toServerDuration, relativeToClocks } from '@datadog/browser-core';\nimport { supportPerformanceEntry } from '../../../browser/performanceCollection';\nimport { RumEventType } from '../../../rawRumEvent.types';\nimport { LifeCycleEventType } from '../../lifeCycle';\nimport { matchRequestTiming } from './matchRequestTiming';\nimport { computePerformanceResourceDetails, computePerformanceResourceDuration, computeResourceKind, computeSize, isRequestKind } from './resourceUtils';\nexport function startResourceCollection(lifeCycle, session) {\n  lifeCycle.subscribe(LifeCycleEventType.REQUEST_COMPLETED, function (request) {\n    if (session.isTrackedWithResource()) {\n      lifeCycle.notify(LifeCycleEventType.RAW_RUM_EVENT_COLLECTED, processRequest(request));\n    }\n  });\n  lifeCycle.subscribe(LifeCycleEventType.PERFORMANCE_ENTRY_COLLECTED, function (entry) {\n    if (session.isTrackedWithResource() && entry.entryType === 'resource' && !isRequestKind(entry)) {\n      lifeCycle.notify(LifeCycleEventType.RAW_RUM_EVENT_COLLECTED, processResourceEntry(entry));\n    }\n  });\n}\nfunction processRequest(request) {\n  var type = request.type === RequestType.XHR ? ResourceType.XHR : ResourceType.FETCH;\n  var matchingTiming = matchRequestTiming(request);\n  var startClocks = matchingTiming ? relativeToClocks(matchingTiming.startTime) : request.startClocks;\n  var correspondingTimingOverrides = matchingTiming ? computePerformanceEntryMetrics(matchingTiming) : undefined;\n  var tracingInfo = computeRequestTracingInfo(request);\n  var resourceEvent = combine({\n    date: startClocks.timeStamp,\n    resource: {\n      id: generateUUID(),\n      type: type,\n      duration: toServerDuration(request.duration),\n      method: request.method,\n      status_code: request.status,\n      url: request.url\n    },\n    type: RumEventType.RESOURCE\n  }, tracingInfo, correspondingTimingOverrides);\n  return {\n    startTime: startClocks.relative,\n    rawRumEvent: resourceEvent,\n    domainContext: {\n      performanceEntry: matchingTiming && toPerformanceEntryRepresentation(matchingTiming),\n      xhr: request.xhr,\n      response: request.response,\n      requestInput: request.input,\n      requestInit: request.init,\n      error: request.error\n    }\n  };\n}\nfunction processResourceEntry(entry) {\n  var type = computeResourceKind(entry);\n  var entryMetrics = computePerformanceEntryMetrics(entry);\n  var tracingInfo = computeEntryTracingInfo(entry);\n  var startClocks = relativeToClocks(entry.startTime);\n  var resourceEvent = combine({\n    date: startClocks.timeStamp,\n    resource: {\n      id: generateUUID(),\n      type: type,\n      url: entry.name\n    },\n    type: RumEventType.RESOURCE\n  }, tracingInfo, entryMetrics);\n  return {\n    startTime: startClocks.relative,\n    rawRumEvent: resourceEvent,\n    domainContext: {\n      performanceEntry: toPerformanceEntryRepresentation(entry)\n    }\n  };\n}\nfunction computePerformanceEntryMetrics(timing) {\n  return {\n    resource: __assign({\n      duration: computePerformanceResourceDuration(timing),\n      size: computeSize(timing)\n    }, computePerformanceResourceDetails(timing))\n  };\n}\nfunction computeRequestTracingInfo(request) {\n  var hasBeenTraced = request.traceId && request.spanId;\n  if (!hasBeenTraced) {\n    return undefined;\n  }\n  return {\n    _dd: {\n      span_id: request.spanId.toDecimalString(),\n      trace_id: request.traceId.toDecimalString()\n    }\n  };\n}\nfunction computeEntryTracingInfo(entry) {\n  return entry.traceId ? {\n    _dd: {\n      trace_id: entry.traceId\n    }\n  } : undefined;\n}\nfunction toPerformanceEntryRepresentation(entry) {\n  if (supportPerformanceEntry() && entry instanceof PerformanceEntry) {\n    entry.toJSON();\n  }\n  return entry;\n}","map":{"version":3,"names":["combine","generateUUID","RequestType","ResourceType","toServerDuration","relativeToClocks","supportPerformanceEntry","RumEventType","LifeCycleEventType","matchRequestTiming","computePerformanceResourceDetails","computePerformanceResourceDuration","computeResourceKind","computeSize","isRequestKind","startResourceCollection","lifeCycle","session","subscribe","REQUEST_COMPLETED","request","isTrackedWithResource","notify","RAW_RUM_EVENT_COLLECTED","processRequest","PERFORMANCE_ENTRY_COLLECTED","entry","entryType","processResourceEntry","type","XHR","FETCH","matchingTiming","startClocks","startTime","correspondingTimingOverrides","computePerformanceEntryMetrics","undefined","tracingInfo","computeRequestTracingInfo","resourceEvent","date","timeStamp","resource","id","duration","method","status_code","status","url","RESOURCE","relative","rawRumEvent","domainContext","performanceEntry","toPerformanceEntryRepresentation","xhr","response","requestInput","input","requestInit","init","error","entryMetrics","computeEntryTracingInfo","name","timing","__assign","size","hasBeenTraced","traceId","spanId","_dd","span_id","toDecimalString","trace_id","PerformanceEntry","toJSON"],"sources":["../../../../src/domain/rumEventsCollection/resource/resourceCollection.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module"}