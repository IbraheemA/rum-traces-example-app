{"ast":null,"code":"import { __spreadArrays } from \"tslib\";\nimport { combine, createErrorFilter, isEmptyObject, limitModification, timeStampNow, currentDrift, display, addMonitoringMessage, relativeNow } from '@datadog/browser-core';\nimport { RumEventType } from '../rawRumEvent.types';\nimport { LifeCycleEventType } from './lifeCycle';\nvar SessionType;\n(function (SessionType) {\n  SessionType[\"SYNTHETICS\"] = \"synthetics\";\n  SessionType[\"USER\"] = \"user\";\n})(SessionType || (SessionType = {}));\nvar VIEW_EVENTS_MODIFIABLE_FIELD_PATHS = [\n// Fields with sensitive data\n'view.url', 'view.referrer', 'action.target.name', 'error.message', 'error.stack', 'error.resource.url', 'resource.url'];\nvar OTHER_EVENTS_MODIFIABLE_FIELD_PATHS = __spreadArrays(VIEW_EVENTS_MODIFIABLE_FIELD_PATHS, [\n// User-customizable field\n'context']);\nexport function startRumAssembly(applicationId, configuration, lifeCycle, session, parentContexts, getCommonContext) {\n  var errorFilter = createErrorFilter(configuration, function (error) {\n    lifeCycle.notify(LifeCycleEventType.RAW_ERROR_COLLECTED, {\n      error: error\n    });\n  });\n  lifeCycle.subscribe(LifeCycleEventType.RAW_RUM_EVENT_COLLECTED, function (_a) {\n    var startTime = _a.startTime,\n      rawRumEvent = _a.rawRumEvent,\n      domainContext = _a.domainContext,\n      savedCommonContext = _a.savedCommonContext,\n      customerContext = _a.customerContext;\n    var viewContext = parentContexts.findView(startTime);\n    if (session.isTracked() && viewContext && viewContext.session.id === session.getId()) {\n      var actionContext = parentContexts.findAction(startTime);\n      var commonContext = savedCommonContext || getCommonContext();\n      var rumContext = {\n        _dd: {\n          format_version: 2,\n          drift: currentDrift()\n        },\n        application: {\n          id: applicationId\n        },\n        date: timeStampNow(),\n        service: configuration.service,\n        session: {\n          // must be computed on each event because synthetics instrumentation can be done after sdk execution\n          // cf https://github.com/puppeteer/puppeteer/issues/3667\n          type: getSessionType()\n        }\n      };\n      var serverRumEvent = needToAssembleWithAction(rawRumEvent) ? combine(rumContext, viewContext, actionContext, rawRumEvent) : combine(rumContext, viewContext, rawRumEvent);\n      serverRumEvent.context = combine(commonContext.context, customerContext);\n      if (!('has_replay' in serverRumEvent.session)) {\n        ;\n        serverRumEvent.session.has_replay = commonContext.hasReplay;\n      }\n      if (!isEmptyObject(commonContext.user)) {\n        ;\n        serverRumEvent.usr = commonContext.user;\n      }\n      if (shouldSend(serverRumEvent, configuration.beforeSend, domainContext, errorFilter)) {\n        if (isEmptyObject(serverRumEvent.context)) {\n          delete serverRumEvent.context;\n        }\n        if (typeof serverRumEvent.date !== 'number') {\n          addMonitoringMessage('invalid date', {\n            debug: {\n              eventType: serverRumEvent.type,\n              eventTimeStamp: serverRumEvent.date,\n              eventRelativeTime: Math.round(startTime),\n              timeStampNow: timeStampNow(),\n              relativeNow: Math.round(relativeNow()),\n              drift: currentDrift()\n            }\n          });\n        }\n        lifeCycle.notify(LifeCycleEventType.RUM_EVENT_COLLECTED, serverRumEvent);\n      }\n    }\n  });\n}\nfunction shouldSend(event, beforeSend, domainContext, errorFilter) {\n  if (beforeSend) {\n    var result = limitModification(event, event.type === RumEventType.VIEW ? VIEW_EVENTS_MODIFIABLE_FIELD_PATHS : OTHER_EVENTS_MODIFIABLE_FIELD_PATHS, function (event) {\n      return beforeSend(event, domainContext);\n    });\n    if (result === false && event.type !== RumEventType.VIEW) {\n      return false;\n    }\n    if (result === false) {\n      display.warn(\"Can't dismiss view events using beforeSend!\");\n    }\n  }\n  if (event.type === RumEventType.ERROR) {\n    return !errorFilter.isLimitReached();\n  }\n  return true;\n}\nfunction needToAssembleWithAction(event) {\n  return [RumEventType.ERROR, RumEventType.RESOURCE, RumEventType.LONG_TASK].indexOf(event.type) !== -1;\n}\nfunction getSessionType() {\n  return window._DATADOG_SYNTHETICS_BROWSER === undefined ? SessionType.USER : SessionType.SYNTHETICS;\n}","map":{"version":3,"names":["combine","createErrorFilter","isEmptyObject","limitModification","timeStampNow","currentDrift","display","addMonitoringMessage","relativeNow","RumEventType","LifeCycleEventType","SessionType","VIEW_EVENTS_MODIFIABLE_FIELD_PATHS","OTHER_EVENTS_MODIFIABLE_FIELD_PATHS","__spreadArrays","startRumAssembly","applicationId","configuration","lifeCycle","session","parentContexts","getCommonContext","errorFilter","error","notify","RAW_ERROR_COLLECTED","subscribe","RAW_RUM_EVENT_COLLECTED","_a","startTime","rawRumEvent","domainContext","savedCommonContext","customerContext","viewContext","findView","isTracked","id","getId","actionContext","findAction","commonContext","rumContext","_dd","format_version","drift","application","date","service","type","getSessionType","serverRumEvent","needToAssembleWithAction","context","has_replay","hasReplay","user","usr","shouldSend","beforeSend","debug","eventType","eventTimeStamp","eventRelativeTime","Math","round","RUM_EVENT_COLLECTED","event","result","VIEW","warn","ERROR","isLimitReached","RESOURCE","LONG_TASK","indexOf","window","_DATADOG_SYNTHETICS_BROWSER","undefined","USER","SYNTHETICS"],"sources":["../../src/domain/assembly.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module"}