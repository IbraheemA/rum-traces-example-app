{"ast":null,"code":"import { RequestType, startFetchProxy, startXhrProxy } from '@datadog/browser-core';\nimport { LifeCycleEventType } from './lifeCycle';\nimport { isAllowedRequestUrl } from './rumEventsCollection/resource/resourceUtils';\nimport { startTracer } from './tracing/tracer';\nvar nextRequestIndex = 1;\nexport function startRequestCollection(lifeCycle, configuration) {\n  var tracer = startTracer(configuration);\n  trackXhr(lifeCycle, configuration, tracer);\n  trackFetch(lifeCycle, configuration, tracer);\n}\nexport function trackXhr(lifeCycle, configuration, tracer) {\n  var xhrProxy = startXhrProxy();\n  xhrProxy.beforeSend(function (context, xhr) {\n    if (isAllowedRequestUrl(configuration, context.url)) {\n      tracer.traceXhr(context, xhr);\n      context.requestIndex = getNextRequestIndex();\n      lifeCycle.notify(LifeCycleEventType.REQUEST_STARTED, {\n        requestIndex: context.requestIndex\n      });\n    }\n  });\n  xhrProxy.onRequestComplete(function (context) {\n    if (isAllowedRequestUrl(configuration, context.url)) {\n      tracer.clearTracingIfCancelled(context);\n      lifeCycle.notify(LifeCycleEventType.REQUEST_COMPLETED, {\n        duration: context.duration,\n        method: context.method,\n        requestIndex: context.requestIndex,\n        responseText: context.responseText,\n        spanId: context.spanId,\n        startClocks: context.startClocks,\n        status: context.status,\n        traceId: context.traceId,\n        type: RequestType.XHR,\n        url: context.url,\n        xhr: context.xhr\n      });\n    }\n  });\n  return xhrProxy;\n}\nexport function trackFetch(lifeCycle, configuration, tracer) {\n  var fetchProxy = startFetchProxy();\n  fetchProxy.beforeSend(function (context) {\n    if (isAllowedRequestUrl(configuration, context.url)) {\n      tracer.traceFetch(context);\n      context.requestIndex = getNextRequestIndex();\n      lifeCycle.notify(LifeCycleEventType.REQUEST_STARTED, {\n        requestIndex: context.requestIndex\n      });\n    }\n  });\n  fetchProxy.onRequestComplete(function (context) {\n    if (isAllowedRequestUrl(configuration, context.url)) {\n      tracer.clearTracingIfCancelled(context);\n      lifeCycle.notify(LifeCycleEventType.REQUEST_COMPLETED, {\n        duration: context.duration,\n        method: context.method,\n        requestIndex: context.requestIndex,\n        responseText: context.responseText,\n        responseType: context.responseType,\n        spanId: context.spanId,\n        startClocks: context.startClocks,\n        status: context.status,\n        traceId: context.traceId,\n        type: RequestType.FETCH,\n        url: context.url,\n        response: context.response,\n        init: context.init,\n        input: context.input\n      });\n    }\n  });\n  return fetchProxy;\n}\nfunction getNextRequestIndex() {\n  var result = nextRequestIndex;\n  nextRequestIndex += 1;\n  return result;\n}","map":{"version":3,"names":["RequestType","startFetchProxy","startXhrProxy","LifeCycleEventType","isAllowedRequestUrl","startTracer","nextRequestIndex","startRequestCollection","lifeCycle","configuration","tracer","trackXhr","trackFetch","xhrProxy","beforeSend","context","xhr","url","traceXhr","requestIndex","getNextRequestIndex","notify","REQUEST_STARTED","onRequestComplete","clearTracingIfCancelled","REQUEST_COMPLETED","duration","method","responseText","spanId","startClocks","status","traceId","type","XHR","fetchProxy","traceFetch","responseType","FETCH","response","init","input","result"],"sources":["../../src/domain/requestCollection.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module"}