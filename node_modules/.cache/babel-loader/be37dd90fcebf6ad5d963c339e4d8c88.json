{"ast":null,"code":"import { display } from '../tools/display';\nimport { findCommaSeparatedValue, generateUUID, ONE_SECOND } from '../tools/utils';\nexport var COOKIE_ACCESS_DELAY = ONE_SECOND;\nexport function cacheCookieAccess(name, options) {\n  var timeout;\n  var cache;\n  var hasCache = false;\n  var cacheAccess = function () {\n    hasCache = true;\n    clearTimeout(timeout);\n    timeout = setTimeout(function () {\n      hasCache = false;\n    }, COOKIE_ACCESS_DELAY);\n  };\n  return {\n    get: function () {\n      if (hasCache) {\n        return cache;\n      }\n      cache = getCookie(name);\n      cacheAccess();\n      return cache;\n    },\n    set: function (value, expireDelay) {\n      setCookie(name, value, expireDelay, options);\n      cache = value;\n      cacheAccess();\n    }\n  };\n}\nexport function setCookie(name, value, expireDelay, options) {\n  var date = new Date();\n  date.setTime(date.getTime() + expireDelay);\n  var expires = \"expires=\" + date.toUTCString();\n  var sameSite = options && options.crossSite ? 'none' : 'strict';\n  var domain = options && options.domain ? \";domain=\" + options.domain : '';\n  var secure = options && options.secure ? \";secure\" : '';\n  document.cookie = name + \"=\" + value + \";\" + expires + \";path=/;samesite=\" + sameSite + domain + secure;\n}\nexport function getCookie(name) {\n  return findCommaSeparatedValue(document.cookie, name);\n}\nexport function areCookiesAuthorized(options) {\n  if (document.cookie === undefined || document.cookie === null) {\n    return false;\n  }\n  try {\n    // Use a unique cookie name to avoid issues when the SDK is initialized multiple times during\n    // the test cookie lifetime\n    var testCookieName = \"dd_cookie_test_\" + generateUUID();\n    var testCookieValue = 'test';\n    setCookie(testCookieName, testCookieValue, ONE_SECOND, options);\n    return getCookie(testCookieName) === testCookieValue;\n  } catch (error) {\n    display.error(error);\n    return false;\n  }\n}\n/**\n * No API to retrieve it, number of levels for subdomain and suffix are unknown\n * strategy: find the minimal domain on which cookies are allowed to be set\n * https://web.dev/same-site-same-origin/#site\n */\nvar getCurrentSiteCache;\nexport function getCurrentSite() {\n  if (getCurrentSiteCache === undefined) {\n    // Use a unique cookie name to avoid issues when the SDK is initialized multiple times during\n    // the test cookie lifetime\n    var testCookieName = \"dd_site_test_\" + generateUUID();\n    var testCookieValue = 'test';\n    var domainLevels = window.location.hostname.split('.');\n    var candidateDomain = domainLevels.pop();\n    while (domainLevels.length && !getCookie(testCookieName)) {\n      candidateDomain = domainLevels.pop() + \".\" + candidateDomain;\n      setCookie(testCookieName, testCookieValue, ONE_SECOND, {\n        domain: candidateDomain\n      });\n    }\n    getCurrentSiteCache = candidateDomain;\n  }\n  return getCurrentSiteCache;\n}","map":{"version":3,"names":["display","findCommaSeparatedValue","generateUUID","ONE_SECOND","COOKIE_ACCESS_DELAY","cacheCookieAccess","name","options","timeout","cache","hasCache","cacheAccess","clearTimeout","setTimeout","get","getCookie","set","value","expireDelay","setCookie","date","Date","setTime","getTime","expires","toUTCString","sameSite","crossSite","domain","secure","document","cookie","areCookiesAuthorized","undefined","testCookieName","testCookieValue","error","getCurrentSiteCache","getCurrentSite","domainLevels","window","location","hostname","split","candidateDomain","pop","length"],"sources":["../../src/browser/cookie.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module"}