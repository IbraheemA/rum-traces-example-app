{"ast":null,"code":"import { cacheCookieAccess, COOKIE_ACCESS_DELAY } from '../browser/cookie';\nimport { Observable } from '../tools/observable';\nimport * as utils from '../tools/utils';\nimport { monitor } from './internalMonitoring';\nimport { tryOldCookiesMigration } from './oldCookiesMigration';\nexport var SESSION_COOKIE_NAME = '_dd_s';\nexport var SESSION_EXPIRATION_DELAY = 15 * utils.ONE_MINUTE;\nexport var SESSION_TIME_OUT_DELAY = 4 * utils.ONE_HOUR;\nexport var VISIBILITY_CHECK_DELAY = utils.ONE_MINUTE;\n/**\n * Limit access to cookie to avoid performance issues\n */\nexport function startSessionManagement(options, productKey, computeSessionState) {\n  var sessionCookie = cacheCookieAccess(SESSION_COOKIE_NAME, options);\n  tryOldCookiesMigration(sessionCookie);\n  var renewObservable = new Observable();\n  var currentSessionId = retrieveActiveSession(sessionCookie).id;\n  var expandOrRenewSession = utils.throttle(monitor(function () {\n    var session = retrieveActiveSession(sessionCookie);\n    var _a = computeSessionState(session[productKey]),\n      trackingType = _a.trackingType,\n      isTracked = _a.isTracked;\n    session[productKey] = trackingType;\n    if (isTracked && !session.id) {\n      session.id = utils.generateUUID();\n      session.created = String(Date.now());\n    }\n    // save changes and expand session duration\n    persistSession(session, sessionCookie);\n    // If the session id has changed, notify that the session has been renewed\n    if (isTracked && currentSessionId !== session.id) {\n      currentSessionId = session.id;\n      renewObservable.notify();\n    }\n  }), COOKIE_ACCESS_DELAY).throttled;\n  var expandSession = function () {\n    var session = retrieveActiveSession(sessionCookie);\n    persistSession(session, sessionCookie);\n  };\n  expandOrRenewSession();\n  trackActivity(expandOrRenewSession);\n  trackVisibility(expandSession);\n  return {\n    getId: function () {\n      return retrieveActiveSession(sessionCookie).id;\n    },\n    getTrackingType: function () {\n      return retrieveActiveSession(sessionCookie)[productKey];\n    },\n    renewObservable: renewObservable\n  };\n}\nvar SESSION_ENTRY_REGEXP = /^([a-z]+)=([a-z0-9-]+)$/;\nvar SESSION_ENTRY_SEPARATOR = '&';\nexport function isValidSessionString(sessionString) {\n  return sessionString !== undefined && (sessionString.indexOf(SESSION_ENTRY_SEPARATOR) !== -1 || SESSION_ENTRY_REGEXP.test(sessionString));\n}\nfunction retrieveActiveSession(sessionCookie) {\n  var session = retrieveSession(sessionCookie);\n  if (isActiveSession(session)) {\n    return session;\n  }\n  clearSession(sessionCookie);\n  return {};\n}\nfunction isActiveSession(session) {\n  // created and expire can be undefined for versions which was not storing them\n  // these checks could be removed when older versions will not be available/live anymore\n  return (session.created === undefined || Date.now() - Number(session.created) < SESSION_TIME_OUT_DELAY) && (session.expire === undefined || Date.now() < Number(session.expire));\n}\nfunction retrieveSession(sessionCookie) {\n  var sessionString = sessionCookie.get();\n  var session = {};\n  if (isValidSessionString(sessionString)) {\n    sessionString.split(SESSION_ENTRY_SEPARATOR).forEach(function (entry) {\n      var matches = SESSION_ENTRY_REGEXP.exec(entry);\n      if (matches !== null) {\n        var key = matches[1],\n          value = matches[2];\n        session[key] = value;\n      }\n    });\n  }\n  return session;\n}\nexport function persistSession(session, cookie) {\n  if (utils.isEmptyObject(session)) {\n    clearSession(cookie);\n    return;\n  }\n  session.expire = String(Date.now() + SESSION_EXPIRATION_DELAY);\n  var cookieString = utils.objectEntries(session).map(function (_a) {\n    var key = _a[0],\n      value = _a[1];\n    return key + \"=\" + value;\n  }).join(SESSION_ENTRY_SEPARATOR);\n  cookie.set(cookieString, SESSION_EXPIRATION_DELAY);\n}\nfunction clearSession(cookie) {\n  cookie.set('', 0);\n}\nexport function stopSessionManagement() {\n  stopCallbacks.forEach(function (e) {\n    return e();\n  });\n  stopCallbacks = [];\n}\nvar stopCallbacks = [];\nexport function trackActivity(expandOrRenewSession) {\n  var stop = utils.addEventListeners(window, [\"click\" /* CLICK */, \"touchstart\" /* TOUCH_START */, \"keydown\" /* KEY_DOWN */, \"scroll\" /* SCROLL */], expandOrRenewSession, {\n    capture: true,\n    passive: true\n  }).stop;\n  stopCallbacks.push(stop);\n}\nfunction trackVisibility(expandSession) {\n  var expandSessionWhenVisible = monitor(function () {\n    if (document.visibilityState === 'visible') {\n      expandSession();\n    }\n  });\n  var stop = utils.addEventListener(document, \"visibilitychange\" /* VISIBILITY_CHANGE */, expandSessionWhenVisible).stop;\n  stopCallbacks.push(stop);\n  var visibilityCheckInterval = setInterval(expandSessionWhenVisible, VISIBILITY_CHECK_DELAY);\n  stopCallbacks.push(function () {\n    clearInterval(visibilityCheckInterval);\n  });\n}","map":{"version":3,"names":["cacheCookieAccess","COOKIE_ACCESS_DELAY","Observable","utils","monitor","tryOldCookiesMigration","SESSION_COOKIE_NAME","SESSION_EXPIRATION_DELAY","ONE_MINUTE","SESSION_TIME_OUT_DELAY","ONE_HOUR","VISIBILITY_CHECK_DELAY","startSessionManagement","options","productKey","computeSessionState","sessionCookie","renewObservable","currentSessionId","retrieveActiveSession","id","expandOrRenewSession","throttle","session","_a","trackingType","isTracked","generateUUID","created","String","Date","now","persistSession","notify","throttled","expandSession","trackActivity","trackVisibility","getId","getTrackingType","SESSION_ENTRY_REGEXP","SESSION_ENTRY_SEPARATOR","isValidSessionString","sessionString","undefined","indexOf","test","retrieveSession","isActiveSession","clearSession","Number","expire","get","split","forEach","entry","matches","exec","key","value","cookie","isEmptyObject","cookieString","objectEntries","map","join","set","stopSessionManagement","stopCallbacks","e","stop","addEventListeners","window","capture","passive","push","expandSessionWhenVisible","document","visibilityState","addEventListener","visibilityCheckInterval","setInterval","clearInterval"],"sources":["../../src/domain/sessionManagement.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module"}