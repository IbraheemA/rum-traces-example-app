{"ast":null,"code":"import { __assign } from \"tslib\";\nimport { elapsed, generateUUID, monitor, ONE_MINUTE, throttle, clocksNow, clocksOrigin, timeStampNow, display } from '@datadog/browser-core';\nimport { ViewLoadingType } from '../../../rawRumEvent.types';\nimport { LifeCycleEventType } from '../../lifeCycle';\nimport { trackInitialViewTimings } from './trackInitialViewTimings';\nimport { trackLocationChanges, areDifferentLocation } from './trackLocationChanges';\nimport { trackViewMetrics } from './trackViewMetrics';\nexport var THROTTLE_VIEW_UPDATE_PERIOD = 3000;\nexport var SESSION_KEEP_ALIVE_INTERVAL = 5 * ONE_MINUTE;\nexport function trackViews(location, lifeCycle, domMutationObservable, areViewsTrackedAutomatically, initialViewName) {\n  var isRecording = false;\n  var _a = trackInitialView(initialViewName),\n    stopInitialViewTracking = _a.stop,\n    initialView = _a.initialView;\n  var currentView = initialView;\n  var stopViewLifeCycle = startViewLifeCycle().stop;\n  var stopViewCollectionMode = (areViewsTrackedAutomatically ? startAutomaticViewCollection() : startManualViewCollection()).stop;\n  function trackInitialView(name) {\n    var initialView = newView(lifeCycle, domMutationObservable, location, isRecording, ViewLoadingType.INITIAL_LOAD, document.referrer, clocksOrigin(), name);\n    var stop = trackInitialViewTimings(lifeCycle, function (timings) {\n      initialView.updateTimings(timings);\n      initialView.scheduleUpdate();\n    }).stop;\n    return {\n      initialView: initialView,\n      stop: stop\n    };\n  }\n  function trackViewChange(startClocks, name) {\n    return newView(lifeCycle, domMutationObservable, location, isRecording, ViewLoadingType.ROUTE_CHANGE, currentView.url, startClocks, name);\n  }\n  function startViewLifeCycle() {\n    lifeCycle.subscribe(LifeCycleEventType.SESSION_RENEWED, function () {\n      // do not trigger view update to avoid wrong data\n      currentView.end();\n      // Renew view on session renewal\n      currentView = trackViewChange(undefined, currentView.name);\n    });\n    // End the current view on page unload\n    lifeCycle.subscribe(LifeCycleEventType.BEFORE_UNLOAD, function () {\n      currentView.end();\n      currentView.triggerUpdate();\n    });\n    lifeCycle.subscribe(LifeCycleEventType.RECORD_STARTED, function () {\n      isRecording = true;\n      currentView.updateHasReplay(true);\n    });\n    lifeCycle.subscribe(LifeCycleEventType.RECORD_STOPPED, function () {\n      isRecording = false;\n    });\n    // Session keep alive\n    var keepAliveInterval = window.setInterval(monitor(function () {\n      currentView.triggerUpdate();\n    }), SESSION_KEEP_ALIVE_INTERVAL);\n    return {\n      stop: function () {\n        clearInterval(keepAliveInterval);\n      }\n    };\n  }\n  function startAutomaticViewCollection() {\n    return trackLocationChanges(function () {\n      if (areDifferentLocation(currentView.getLocation(), location)) {\n        // Renew view on location changes\n        currentView.end();\n        currentView.triggerUpdate();\n        currentView = trackViewChange();\n        return;\n      }\n      currentView.updateLocation(location);\n      currentView.triggerUpdate();\n    });\n  }\n  function startManualViewCollection() {\n    return trackLocationChanges(function () {\n      currentView.updateLocation(location);\n      currentView.triggerUpdate();\n    });\n  }\n  return {\n    addTiming: function (name, time) {\n      if (time === void 0) {\n        time = timeStampNow();\n      }\n      currentView.addTiming(name, time);\n      currentView.triggerUpdate();\n    },\n    startView: function (name, startClocks) {\n      currentView.end(startClocks);\n      currentView.triggerUpdate();\n      currentView = trackViewChange(startClocks, name);\n    },\n    stop: function () {\n      stopViewCollectionMode();\n      stopInitialViewTracking();\n      stopViewLifeCycle();\n      currentView.end();\n    }\n  };\n}\nfunction newView(lifeCycle, domMutationObservable, initialLocation, initialHasReplay, loadingType, referrer, startClocks, name) {\n  if (startClocks === void 0) {\n    startClocks = clocksNow();\n  }\n  // Setup initial values\n  var id = generateUUID();\n  var timings = {};\n  var customTimings = {};\n  var documentVersion = 0;\n  var endClocks;\n  var location = __assign({}, initialLocation);\n  var hasReplay = initialHasReplay;\n  lifeCycle.notify(LifeCycleEventType.VIEW_CREATED, {\n    id: id,\n    name: name,\n    startClocks: startClocks,\n    location: location,\n    referrer: referrer\n  });\n  // Update the view every time the measures are changing\n  var _a = throttle(monitor(triggerViewUpdate), THROTTLE_VIEW_UPDATE_PERIOD, {\n      leading: false\n    }),\n    scheduleViewUpdate = _a.throttled,\n    cancelScheduleViewUpdate = _a.cancel;\n  var _b = trackViewMetrics(lifeCycle, domMutationObservable, scheduleViewUpdate, loadingType),\n    setLoadEvent = _b.setLoadEvent,\n    stopViewMetricsTracking = _b.stop,\n    viewMetrics = _b.viewMetrics;\n  // Initial view update\n  triggerViewUpdate();\n  function triggerViewUpdate() {\n    documentVersion += 1;\n    var currentEnd = endClocks === undefined ? timeStampNow() : endClocks.timeStamp;\n    lifeCycle.notify(LifeCycleEventType.VIEW_UPDATED, __assign(__assign({}, viewMetrics), {\n      customTimings: customTimings,\n      documentVersion: documentVersion,\n      id: id,\n      name: name,\n      loadingType: loadingType,\n      location: location,\n      hasReplay: hasReplay,\n      referrer: referrer,\n      startClocks: startClocks,\n      timings: timings,\n      duration: elapsed(startClocks.timeStamp, currentEnd),\n      isActive: endClocks === undefined\n    }));\n  }\n  return {\n    name: name,\n    scheduleUpdate: scheduleViewUpdate,\n    end: function (clocks) {\n      if (clocks === void 0) {\n        clocks = clocksNow();\n      }\n      endClocks = clocks;\n      stopViewMetricsTracking();\n      lifeCycle.notify(LifeCycleEventType.VIEW_ENDED, {\n        endClocks: endClocks\n      });\n    },\n    getLocation: function () {\n      return location;\n    },\n    triggerUpdate: function () {\n      // cancel any pending view updates execution\n      cancelScheduleViewUpdate();\n      triggerViewUpdate();\n    },\n    updateTimings: function (newTimings) {\n      timings = newTimings;\n      if (newTimings.loadEvent !== undefined) {\n        setLoadEvent(newTimings.loadEvent);\n      }\n    },\n    addTiming: function (name, time) {\n      customTimings[sanitizeTiming(name)] = elapsed(startClocks.timeStamp, time);\n    },\n    updateLocation: function (newLocation) {\n      location = __assign({}, newLocation);\n    },\n    updateHasReplay: function (newHasReplay) {\n      hasReplay = newHasReplay;\n    },\n    get url() {\n      return location.href;\n    }\n  };\n}\n/**\n * Timing name is used as facet path that must contain only letters, digits, or the characters - _ . @ $\n */\nfunction sanitizeTiming(name) {\n  var sanitized = name.replace(/[^a-zA-Z0-9-_.@$]/g, '_');\n  if (sanitized !== name) {\n    display.warn(\"Invalid timing name: \" + name + \", sanitized to: \" + sanitized);\n  }\n  return sanitized;\n}","map":{"version":3,"names":["elapsed","generateUUID","monitor","ONE_MINUTE","throttle","clocksNow","clocksOrigin","timeStampNow","display","ViewLoadingType","LifeCycleEventType","trackInitialViewTimings","trackLocationChanges","areDifferentLocation","trackViewMetrics","THROTTLE_VIEW_UPDATE_PERIOD","SESSION_KEEP_ALIVE_INTERVAL","trackViews","location","lifeCycle","domMutationObservable","areViewsTrackedAutomatically","initialViewName","isRecording","_a","trackInitialView","stopInitialViewTracking","stop","initialView","currentView","stopViewLifeCycle","startViewLifeCycle","stopViewCollectionMode","startAutomaticViewCollection","startManualViewCollection","name","newView","INITIAL_LOAD","document","referrer","timings","updateTimings","scheduleUpdate","trackViewChange","startClocks","ROUTE_CHANGE","url","subscribe","SESSION_RENEWED","end","undefined","BEFORE_UNLOAD","triggerUpdate","RECORD_STARTED","updateHasReplay","RECORD_STOPPED","keepAliveInterval","window","setInterval","clearInterval","getLocation","updateLocation","addTiming","time","startView","initialLocation","initialHasReplay","loadingType","id","customTimings","documentVersion","endClocks","__assign","hasReplay","notify","VIEW_CREATED","triggerViewUpdate","leading","scheduleViewUpdate","throttled","cancelScheduleViewUpdate","cancel","_b","setLoadEvent","stopViewMetricsTracking","viewMetrics","currentEnd","timeStamp","VIEW_UPDATED","duration","isActive","clocks","VIEW_ENDED","newTimings","loadEvent","sanitizeTiming","newLocation","newHasReplay","href","sanitized","replace","warn"],"sources":["../../../../src/domain/rumEventsCollection/view/trackViews.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module"}