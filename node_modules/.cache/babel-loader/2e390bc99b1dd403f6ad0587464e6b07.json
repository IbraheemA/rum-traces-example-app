{"ast":null,"code":"import { __assign } from \"tslib\";\nimport { addEventListeners, getRelativeTime, isNumber, monitor, relativeNow, runOnReadyState } from '@datadog/browser-core';\nimport { LifeCycleEventType } from '../domain/lifeCycle';\nimport { FAKE_INITIAL_DOCUMENT, isAllowedRequestUrl } from '../domain/rumEventsCollection/resource/resourceUtils';\nimport { getDocumentTraceId } from '../domain/tracing/getDocumentTraceId';\nfunction supportPerformanceObject() {\n  return window.performance !== undefined && 'getEntries' in performance;\n}\nexport function supportPerformanceTimingEvent(entryType) {\n  return window.PerformanceObserver && PerformanceObserver.supportedEntryTypes !== undefined && PerformanceObserver.supportedEntryTypes.includes(entryType);\n}\nexport function supportPerformanceEntry() {\n  // Safari 10 doesn't support PerformanceEntry\n  return typeof PerformanceEntry === 'function';\n}\nexport function startPerformanceCollection(lifeCycle, configuration) {\n  retrieveInitialDocumentResourceTiming(function (timing) {\n    handleRumPerformanceEntry(lifeCycle, configuration, timing);\n  });\n  if (supportPerformanceObject()) {\n    handlePerformanceEntries(lifeCycle, configuration, performance.getEntries());\n  }\n  if (window.PerformanceObserver) {\n    var observer = new PerformanceObserver(monitor(function (entries) {\n      return handlePerformanceEntries(lifeCycle, configuration, entries.getEntries());\n    }));\n    var entryTypes = ['resource', 'navigation', 'longtask', 'paint', 'largest-contentful-paint', 'first-input', 'layout-shift'];\n    observer.observe({\n      entryTypes: entryTypes\n    });\n    if (supportPerformanceObject() && 'addEventListener' in performance) {\n      // https://bugzilla.mozilla.org/show_bug.cgi?id=1559377\n      performance.addEventListener('resourcetimingbufferfull', function () {\n        performance.clearResourceTimings();\n      });\n    }\n  }\n  if (!supportPerformanceTimingEvent('navigation')) {\n    retrieveNavigationTiming(function (timing) {\n      handleRumPerformanceEntry(lifeCycle, configuration, timing);\n    });\n  }\n  if (!supportPerformanceTimingEvent('first-input')) {\n    retrieveFirstInputTiming(function (timing) {\n      handleRumPerformanceEntry(lifeCycle, configuration, timing);\n    });\n  }\n}\nexport function retrieveInitialDocumentResourceTiming(callback) {\n  runOnReadyState('interactive', function () {\n    var timing;\n    var forcedAttributes = {\n      entryType: 'resource',\n      initiatorType: FAKE_INITIAL_DOCUMENT,\n      traceId: getDocumentTraceId(document)\n    };\n    if (supportPerformanceTimingEvent('navigation') && performance.getEntriesByType('navigation').length > 0) {\n      var navigationEntry = performance.getEntriesByType('navigation')[0];\n      timing = __assign(__assign({}, navigationEntry.toJSON()), forcedAttributes);\n    } else {\n      var relativePerformanceTiming = computeRelativePerformanceTiming();\n      timing = __assign(__assign(__assign({}, relativePerformanceTiming), {\n        decodedBodySize: 0,\n        duration: relativePerformanceTiming.responseEnd,\n        name: window.location.href,\n        startTime: 0\n      }), forcedAttributes);\n    }\n    callback(timing);\n  });\n}\nfunction retrieveNavigationTiming(callback) {\n  function sendFakeTiming() {\n    callback(__assign(__assign({}, computeRelativePerformanceTiming()), {\n      entryType: 'navigation'\n    }));\n  }\n  runOnReadyState('complete', function () {\n    // Send it a bit after the actual load event, so the \"loadEventEnd\" timing is accurate\n    setTimeout(monitor(sendFakeTiming));\n  });\n}\n/**\n * first-input timing entry polyfill based on\n * https://github.com/GoogleChrome/web-vitals/blob/master/src/lib/polyfills/firstInputPolyfill.ts\n */\nfunction retrieveFirstInputTiming(callback) {\n  var startTimeStamp = Date.now();\n  var timingSent = false;\n  var removeEventListeners = addEventListeners(window, [\"click\" /* CLICK */, \"mousedown\" /* MOUSE_DOWN */, \"keydown\" /* KEY_DOWN */, \"touchstart\" /* TOUCH_START */, \"pointerdown\" /* POINTER_DOWN */], function (evt) {\n    // Only count cancelable events, which should trigger behavior important to the user.\n    if (!evt.cancelable) {\n      return;\n    }\n    // This timing will be used to compute the \"first Input delay\", which is the delta between\n    // when the system received the event (e.g. evt.timeStamp) and when it could run the callback\n    // (e.g. performance.now()).\n    var timing = {\n      entryType: 'first-input',\n      processingStart: relativeNow(),\n      startTime: evt.timeStamp\n    };\n    if (evt.type === \"pointerdown\" /* POINTER_DOWN */) {\n      sendTimingIfPointerIsNotCancelled(timing);\n    } else {\n      sendTiming(timing);\n    }\n  }, {\n    passive: true,\n    capture: true\n  }).stop;\n  /**\n   * Pointer events are a special case, because they can trigger main or compositor thread behavior.\n   * We differentiate these cases based on whether or not we see a pointercancel event, which are\n   * fired when we scroll. If we're scrolling we don't need to report input delay since FID excludes\n   * scrolling and pinch/zooming.\n   */\n  function sendTimingIfPointerIsNotCancelled(timing) {\n    addEventListeners(window, [\"pointerup\" /* POINTER_UP */, \"pointercancel\" /* POINTER_CANCEL */], function (event) {\n      if (event.type === \"pointerup\" /* POINTER_UP */) {\n        sendTiming(timing);\n      }\n    }, {\n      once: true\n    });\n  }\n  function sendTiming(timing) {\n    if (!timingSent) {\n      timingSent = true;\n      removeEventListeners();\n      // In some cases the recorded delay is clearly wrong, e.g. it's negative or it's larger than\n      // the time between now and when the page was loaded.\n      // - https://github.com/GoogleChromeLabs/first-input-delay/issues/4\n      // - https://github.com/GoogleChromeLabs/first-input-delay/issues/6\n      // - https://github.com/GoogleChromeLabs/first-input-delay/issues/7\n      var delay = timing.processingStart - timing.startTime;\n      if (delay >= 0 && delay < Date.now() - startTimeStamp) {\n        callback(timing);\n      }\n    }\n  }\n}\nfunction computeRelativePerformanceTiming() {\n  var result = {};\n  var timing = performance.timing;\n  for (var key in timing) {\n    if (isNumber(timing[key])) {\n      var numberKey = key;\n      // eslint-disable-next-line @typescript-eslint/no-unnecessary-type-assertion\n      var timingElement = timing[numberKey];\n      result[numberKey] = timingElement === 0 ? 0 : getRelativeTime(timingElement);\n    }\n  }\n  return result;\n}\nfunction handlePerformanceEntries(lifeCycle, configuration, entries) {\n  entries.forEach(function (entry) {\n    if (entry.entryType === 'resource' || entry.entryType === 'navigation' || entry.entryType === 'paint' || entry.entryType === 'longtask' || entry.entryType === 'largest-contentful-paint' || entry.entryType === 'first-input' || entry.entryType === 'layout-shift') {\n      handleRumPerformanceEntry(lifeCycle, configuration, entry);\n    }\n  });\n}\nfunction handleRumPerformanceEntry(lifeCycle, configuration, entry) {\n  if (isIncompleteNavigation(entry) || isForbiddenResource(configuration, entry)) {\n    return;\n  }\n  lifeCycle.notify(LifeCycleEventType.PERFORMANCE_ENTRY_COLLECTED, entry);\n}\nfunction isIncompleteNavigation(entry) {\n  return entry.entryType === 'navigation' && entry.loadEventEnd <= 0;\n}\nfunction isForbiddenResource(configuration, entry) {\n  return entry.entryType === 'resource' && !isAllowedRequestUrl(configuration, entry.name);\n}","map":{"version":3,"names":["addEventListeners","getRelativeTime","isNumber","monitor","relativeNow","runOnReadyState","LifeCycleEventType","FAKE_INITIAL_DOCUMENT","isAllowedRequestUrl","getDocumentTraceId","supportPerformanceObject","window","performance","undefined","supportPerformanceTimingEvent","entryType","PerformanceObserver","supportedEntryTypes","includes","supportPerformanceEntry","PerformanceEntry","startPerformanceCollection","lifeCycle","configuration","retrieveInitialDocumentResourceTiming","timing","handleRumPerformanceEntry","handlePerformanceEntries","getEntries","observer","entries","entryTypes","observe","addEventListener","clearResourceTimings","retrieveNavigationTiming","retrieveFirstInputTiming","callback","forcedAttributes","initiatorType","traceId","document","getEntriesByType","length","navigationEntry","__assign","toJSON","relativePerformanceTiming","computeRelativePerformanceTiming","decodedBodySize","duration","responseEnd","name","location","href","startTime","sendFakeTiming","setTimeout","startTimeStamp","Date","now","timingSent","removeEventListeners","evt","cancelable","processingStart","timeStamp","type","sendTimingIfPointerIsNotCancelled","sendTiming","passive","capture","stop","event","once","delay","result","key","numberKey","timingElement","forEach","entry","isIncompleteNavigation","isForbiddenResource","notify","PERFORMANCE_ENTRY_COLLECTED","loadEventEnd"],"sources":["../../src/browser/performanceCollection.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module"}