{"ast":null,"code":"import { monitor, ONE_MINUTE, SESSION_TIME_OUT_DELAY, relativeNow } from '@datadog/browser-core';\nimport { LifeCycleEventType } from './lifeCycle';\nexport var VIEW_CONTEXT_TIME_OUT_DELAY = SESSION_TIME_OUT_DELAY;\nexport var ACTION_CONTEXT_TIME_OUT_DELAY = 5 * ONE_MINUTE; // arbitrary\nexport var CLEAR_OLD_CONTEXTS_INTERVAL = ONE_MINUTE;\nexport function startParentContexts(lifeCycle, session) {\n  var currentView;\n  var currentAction;\n  var currentSessionId;\n  var previousViews = [];\n  var previousActions = [];\n  lifeCycle.subscribe(LifeCycleEventType.VIEW_CREATED, function (currentContext) {\n    currentView = currentContext;\n    currentSessionId = session.getId();\n  });\n  lifeCycle.subscribe(LifeCycleEventType.VIEW_UPDATED, function (currentContext) {\n    // A view can be updated after its end.  We have to ensure that the view being updated is the\n    // most recently created.\n    if (currentView && currentView.id === currentContext.id) {\n      currentView = currentContext;\n    }\n  });\n  lifeCycle.subscribe(LifeCycleEventType.VIEW_ENDED, function (_a) {\n    var endClocks = _a.endClocks;\n    if (currentView) {\n      previousViews.unshift({\n        endTime: endClocks.relative,\n        context: buildCurrentViewContext(),\n        startTime: currentView.startClocks.relative\n      });\n      currentView = undefined;\n    }\n  });\n  lifeCycle.subscribe(LifeCycleEventType.AUTO_ACTION_CREATED, function (currentContext) {\n    currentAction = currentContext;\n  });\n  lifeCycle.subscribe(LifeCycleEventType.AUTO_ACTION_COMPLETED, function (action) {\n    if (currentAction) {\n      previousActions.unshift({\n        context: buildCurrentActionContext(),\n        // eslint-disable-next-line @typescript-eslint/restrict-plus-operands\n        endTime: currentAction.startClocks.relative + action.duration,\n        startTime: currentAction.startClocks.relative\n      });\n    }\n    currentAction = undefined;\n  });\n  lifeCycle.subscribe(LifeCycleEventType.AUTO_ACTION_DISCARDED, function () {\n    currentAction = undefined;\n  });\n  lifeCycle.subscribe(LifeCycleEventType.SESSION_RENEWED, function () {\n    previousViews = [];\n    previousActions = [];\n    currentView = undefined;\n    currentAction = undefined;\n  });\n  var clearOldContextsInterval = setInterval(monitor(function () {\n    clearOldContexts(previousViews, VIEW_CONTEXT_TIME_OUT_DELAY);\n    clearOldContexts(previousActions, ACTION_CONTEXT_TIME_OUT_DELAY);\n  }), CLEAR_OLD_CONTEXTS_INTERVAL);\n  function clearOldContexts(previousContexts, timeOutDelay) {\n    var oldTimeThreshold = relativeNow() - timeOutDelay;\n    while (previousContexts.length > 0 && previousContexts[previousContexts.length - 1].startTime < oldTimeThreshold) {\n      previousContexts.pop();\n    }\n  }\n  function buildCurrentViewContext() {\n    return {\n      session: {\n        id: currentSessionId\n      },\n      view: {\n        id: currentView.id,\n        name: currentView.name,\n        referrer: currentView.referrer,\n        url: currentView.location.href\n      }\n    };\n  }\n  function buildCurrentActionContext() {\n    return {\n      action: {\n        id: currentAction.id\n      }\n    };\n  }\n  function findContext(buildContext, previousContexts, currentContext, startTime) {\n    if (startTime === undefined) {\n      return currentContext ? buildContext() : undefined;\n    }\n    if (currentContext && startTime >= currentContext.startClocks.relative) {\n      return buildContext();\n    }\n    for (var _i = 0, previousContexts_1 = previousContexts; _i < previousContexts_1.length; _i++) {\n      var previousContext = previousContexts_1[_i];\n      if (startTime > previousContext.endTime) {\n        break;\n      }\n      if (startTime >= previousContext.startTime) {\n        return previousContext.context;\n      }\n    }\n    return undefined;\n  }\n  return {\n    findAction: function (startTime) {\n      return findContext(buildCurrentActionContext, previousActions, currentAction, startTime);\n    },\n    findView: function (startTime) {\n      return findContext(buildCurrentViewContext, previousViews, currentView, startTime);\n    },\n    stop: function () {\n      clearInterval(clearOldContextsInterval);\n    }\n  };\n}","map":{"version":3,"names":["monitor","ONE_MINUTE","SESSION_TIME_OUT_DELAY","relativeNow","LifeCycleEventType","VIEW_CONTEXT_TIME_OUT_DELAY","ACTION_CONTEXT_TIME_OUT_DELAY","CLEAR_OLD_CONTEXTS_INTERVAL","startParentContexts","lifeCycle","session","currentView","currentAction","currentSessionId","previousViews","previousActions","subscribe","VIEW_CREATED","currentContext","getId","VIEW_UPDATED","id","VIEW_ENDED","_a","endClocks","unshift","endTime","relative","context","buildCurrentViewContext","startTime","startClocks","undefined","AUTO_ACTION_CREATED","AUTO_ACTION_COMPLETED","action","buildCurrentActionContext","duration","AUTO_ACTION_DISCARDED","SESSION_RENEWED","clearOldContextsInterval","setInterval","clearOldContexts","previousContexts","timeOutDelay","oldTimeThreshold","length","pop","view","name","referrer","url","location","href","findContext","buildContext","_i","previousContexts_1","previousContext","findAction","findView","stop","clearInterval"],"sources":["../../src/domain/parentContexts.ts"],"sourcesContent":[null],"mappings":"AAAA,SACEA,OAAO,EACPC,UAAU,EAEVC,sBAAsB,EACtBC,WAAW,QAEN,uBAAuB;AAE9B,SAAoBC,kBAAkB,QAAQ,aAAa;AAK3D,OAAO,IAAMC,2BAA2B,GAAGH,sBAAsB;AACjE,OAAO,IAAMI,6BAA6B,GAAG,CAAC,GAAGL,UAAU,EAAC;AAC5D,OAAO,IAAMM,2BAA2B,GAAGN,UAAU;AAcrD,OAAM,SAAUO,mBAAmBA,CAACC,SAAoB,EAAEC,OAAmB;EAC3E,IAAIC,WAAyC;EAC7C,IAAIC,aAAiD;EACrD,IAAIC,gBAAoC;EAExC,IAAIC,aAAa,GAAwC,EAAE;EAC3D,IAAIC,eAAe,GAA0C,EAAE;EAE/DN,SAAS,CAACO,SAAS,CAACZ,kBAAkB,CAACa,YAAY,EAAE,UAACC,cAAc;IAClEP,WAAW,GAAGO,cAAc;IAC5BL,gBAAgB,GAAGH,OAAO,CAACS,KAAK,EAAE;EACpC,CAAC,CAAC;EAEFV,SAAS,CAACO,SAAS,CAACZ,kBAAkB,CAACgB,YAAY,EAAE,UAACF,cAAc;IAClE;IACA;IACA,IAAIP,WAAW,IAAIA,WAAW,CAACU,EAAE,KAAKH,cAAc,CAACG,EAAE,EAAE;MACvDV,WAAW,GAAGO,cAAc;;EAEhC,CAAC,CAAC;EAEFT,SAAS,CAACO,SAAS,CAACZ,kBAAkB,CAACkB,UAAU,EAAE,UAACC,EAAa;QAAXC,SAAS,GAAAD,EAAA,CAAAC,SAAA;IAC7D,IAAIb,WAAW,EAAE;MACfG,aAAa,CAACW,OAAO,CAAC;QACpBC,OAAO,EAAEF,SAAS,CAACG,QAAQ;QAC3BC,OAAO,EAAEC,uBAAuB,EAAE;QAClCC,SAAS,EAAEnB,WAAW,CAACoB,WAAW,CAACJ;OACpC,CAAC;MACFhB,WAAW,GAAGqB,SAAS;;EAE3B,CAAC,CAAC;EAEFvB,SAAS,CAACO,SAAS,CAACZ,kBAAkB,CAAC6B,mBAAmB,EAAE,UAACf,cAAc;IACzEN,aAAa,GAAGM,cAAc;EAChC,CAAC,CAAC;EAEFT,SAAS,CAACO,SAAS,CAACZ,kBAAkB,CAAC8B,qBAAqB,EAAE,UAACC,MAAkB;IAC/E,IAAIvB,aAAa,EAAE;MACjBG,eAAe,CAACU,OAAO,CAAC;QACtBG,OAAO,EAAEQ,yBAAyB,EAAE;QACpC;QACAV,OAAO,EAAGd,aAAa,CAACmB,WAAW,CAACJ,QAAQ,GAAGQ,MAAM,CAACE,QAAyB;QAC/EP,SAAS,EAAElB,aAAa,CAACmB,WAAW,CAACJ;OACtC,CAAC;;IAEJf,aAAa,GAAGoB,SAAS;EAC3B,CAAC,CAAC;EAEFvB,SAAS,CAACO,SAAS,CAACZ,kBAAkB,CAACkC,qBAAqB,EAAE;IAC5D1B,aAAa,GAAGoB,SAAS;EAC3B,CAAC,CAAC;EAEFvB,SAAS,CAACO,SAAS,CAACZ,kBAAkB,CAACmC,eAAe,EAAE;IACtDzB,aAAa,GAAG,EAAE;IAClBC,eAAe,GAAG,EAAE;IACpBJ,WAAW,GAAGqB,SAAS;IACvBpB,aAAa,GAAGoB,SAAS;EAC3B,CAAC,CAAC;EAEF,IAAMQ,wBAAwB,GAAGC,WAAW,CAC1CzC,OAAO,CAAC;IACN0C,gBAAgB,CAAC5B,aAAa,EAAET,2BAA2B,CAAC;IAC5DqC,gBAAgB,CAAC3B,eAAe,EAAET,6BAA6B,CAAC;EAClE,CAAC,CAAC,EACFC,2BAA2B,CAC5B;EAED,SAASmC,gBAAgBA,CAACC,gBAAiD,EAAEC,YAAoB;IAC/F,IAAMC,gBAAgB,GAAG1C,WAAW,EAAE,GAAGyC,YAAY;IACrD,OAAOD,gBAAgB,CAACG,MAAM,GAAG,CAAC,IAAIH,gBAAgB,CAACA,gBAAgB,CAACG,MAAM,GAAG,CAAC,CAAC,CAAChB,SAAS,GAAGe,gBAAgB,EAAE;MAChHF,gBAAgB,CAACI,GAAG,EAAE;;EAE1B;EAEA,SAASlB,uBAAuBA,CAAA;IAC9B,OAAO;MACLnB,OAAO,EAAE;QACPW,EAAE,EAAER;OACL;MACDmC,IAAI,EAAE;QACJ3B,EAAE,EAAEV,WAAY,CAACU,EAAE;QACnB4B,IAAI,EAAEtC,WAAY,CAACsC,IAAI;QACvBC,QAAQ,EAAEvC,WAAY,CAACuC,QAAQ;QAC/BC,GAAG,EAAExC,WAAY,CAACyC,QAAQ,CAACC;;KAE9B;EACH;EAEA,SAASjB,yBAAyBA,CAAA;IAChC,OAAO;MAAED,MAAM,EAAE;QAAEd,EAAE,EAAET,aAAc,CAACS;MAAE;IAAE,CAAE;EAC9C;EAEA,SAASiC,WAAWA,CAClBC,YAAqB,EACrBZ,gBAA2C,EAC3CzB,cAA6C,EAC7CY,SAAwB;IAExB,IAAIA,SAAS,KAAKE,SAAS,EAAE;MAC3B,OAAOd,cAAc,GAAGqC,YAAY,EAAE,GAAGvB,SAAS;;IAEpD,IAAId,cAAc,IAAIY,SAAS,IAAIZ,cAAc,CAACa,WAAW,CAACJ,QAAQ,EAAE;MACtE,OAAO4B,YAAY,EAAE;;IAEvB,KAA8B,IAAAC,EAAA,IAAgB,EAAhBC,kBAAA,GAAAd,gBAAgB,EAAhBa,EAAA,GAAAC,kBAAA,CAAAX,MAAgB,EAAhBU,EAAA,EAAgB,EAAE;MAA3C,IAAME,eAAe,GAAAD,kBAAA,CAAAD,EAAA;MACxB,IAAI1B,SAAS,GAAG4B,eAAe,CAAChC,OAAO,EAAE;QACvC;;MAEF,IAAII,SAAS,IAAI4B,eAAe,CAAC5B,SAAS,EAAE;QAC1C,OAAO4B,eAAe,CAAC9B,OAAO;;;IAGlC,OAAOI,SAAS;EAClB;EAEA,OAAO;IACL2B,UAAU,EAAE,SAAAA,CAAC7B,SAAS;MAAK,OAAAwB,WAAW,CAAClB,yBAAyB,EAAErB,eAAe,EAAEH,aAAa,EAAEkB,SAAS,CAAC;IAAjF,CAAiF;IAC5G8B,QAAQ,EAAE,SAAAA,CAAC9B,SAAS;MAAK,OAAAwB,WAAW,CAACzB,uBAAuB,EAAEf,aAAa,EAAEH,WAAW,EAAEmB,SAAS,CAAC;IAA3E,CAA2E;IACpG+B,IAAI,EAAE,SAAAA,CAAA;MACJC,aAAa,CAACtB,wBAAwB,CAAC;IACzC;GACD;AACH","ignoreList":[]},"metadata":{},"sourceType":"module"}